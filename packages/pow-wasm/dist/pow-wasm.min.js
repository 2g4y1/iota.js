"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@iota/iota.js"),t=require("os"),r=require("path"),o=require("worker_threads"),n=require("fs");function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=a(t),i=a(r);async function u(e,t,r){const o=await n.promises.readFile(i.default.join(__dirname,"../wasm/build/release.wasm")),a=(await WebAssembly.instantiate(o,function(){const e={abort:(e,t,r,o)=>{},trace:(e,t,...r)=>{},seed:Date.now};return{Math:Math,Date:Date,env:e}}())).instance.exports;for(let t=0;t<e.length;t++)a.setDigest(t,e[t]);const s=BigInt(r),u=s&BigInt(4294967295),c=s>>BigInt(32)&BigInt(4294967295);a.powWorker(t,Number(u),Number(c));const l=a.getNonceLo(),p=a.getNonceHi();return(BigInt(l)|BigInt(p)<<BigInt(32)).toString()}o.workerData&&o.parentPort&&u(o.workerData.powDigest,o.workerData.targetZeros,o.workerData.startIndex).then((e=>{o.parentPort&&o.parentPort.postMessage(e)})).catch((()=>{process.exit(1)})),exports.WasmPowProvider=class{constructor(e){this._numCpus=null!=e?e:s.default.cpus().length}async pow(t,r){const n=t.slice(0,-8),a=e.Blake2b.sum256(n),s=e.PowHelper.calculateTargetZeros(t,r);return new Promise(((e,t)=>{const r=BigInt(0x10000000000000000)/BigInt(this._numCpus),n=[];let u=!1;for(let c=0;c<this._numCpus;c++){const l=new o.Worker(i.default.join(__dirname,"pow-wasm.js"),{workerData:{powDigest:a,targetZeros:s,startIndex:(r*BigInt(c)).toString()}});n.push(l),l.on("message",(async t=>{u=!0;for(let e=0;e<n.length;e++)await n[e].terminate();e(t)})),l.on("error",(e=>{t(e)})),l.on("exit",(e=>{u||0===e||t(new Error(`Worker stopped with exit code ${e}`))}))}}))}},exports.doPow=u;