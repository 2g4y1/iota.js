"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@iota/crypto.js"),t=require("@iota/iota.js"),r=require("os"),o=require("path"),n=require("worker_threads"),a=require("fs");function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=s(r),u=s(o);async function c(e,t,r){const o=await a.promises.readFile(u.default.join(__dirname,"../wasm/build/release.wasm")),n=(await WebAssembly.instantiate(o,function(){const e={abort:(e,t,r,o)=>{},trace:(e,t,...r)=>{},seed:Date.now};return{Math:Math,Date:Date,env:e}}())).instance.exports;for(let t=0;t<e.length;t++)n.setDigest(t,e[t]);const s=BigInt(r),i=s&BigInt(4294967295),c=s>>BigInt(32)&BigInt(4294967295);n.powWorker(t,Number(i),Number(c));const p=n.getNonceLo(),l=n.getNonceHi();return(BigInt(p)|BigInt(l)<<BigInt(32)).toString()}n.workerData&&n.parentPort&&c(n.workerData.powDigest,n.workerData.targetZeros,n.workerData.startIndex).then((e=>{n.parentPort&&n.parentPort.postMessage(e)})).catch((()=>{process.exit(1)})),exports.WasmPowProvider=class{constructor(e){this._numCpus=null!=e?e:i.default.cpus().length}async pow(r,o){const a=r.slice(0,-8),s=e.Blake2b.sum256(a),i=t.PowHelper.calculateTargetZeros(r,o);return new Promise(((e,t)=>{const r=BigInt("18446744073709551615")/BigInt(this._numCpus),o=[];let a=!1;for(let c=0;c<this._numCpus;c++){const p=new n.Worker(u.default.join(__dirname,"pow-wasm.js"),{workerData:{powDigest:s,targetZeros:i,startIndex:(r*BigInt(c)).toString()}});o.push(p),p.on("message",(async t=>{a=!0;for(let e=0;e<o.length;e++)await o[e].terminate();e(t)})),p.on("error",(e=>{t(e)})),p.on("exit",(e=>{a||0===e||t(new Error(`Worker stopped with exit code ${e}`))}))}}))}},exports.doPow=c;