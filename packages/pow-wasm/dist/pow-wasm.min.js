"use strict";var e=require("@iota/iota.js"),t=require("os"),n=require("path"),o=require("worker_threads"),r=require("fs");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=i(e),u=i(t),s=i(n),c=i(o),l=i(r),d="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function f(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var p={},w={},_=d&&d.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function a(e){try{s(o.next(e))}catch(e){i(e)}}function u(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,u)}s((o=o.apply(e,t||[])).next())}))},g=d&&d.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(w,"__esModule",{value:!0}),w.WasmPowProvider=void 0;const h=a.default,v=g(u.default),m=g(s.default),y=c.default;w.WasmPowProvider=class{constructor(e){this._numCpus=null!=e?e:v.default.cpus().length}pow(e,t){return _(this,void 0,void 0,(function*(){const n=e.slice(0,-8),o=h.Blake2b.sum256(n),r=h.PowHelper.calculateTargetZeros(e,t);return new Promise(((e,t)=>{const n=BigInt(0x10000000000000000)/BigInt(this._numCpus),i=[];let a=!1;for(let u=0;u<this._numCpus;u++){const s=new y.Worker(m.default.join(__dirname,"pow-wasm.js"),{workerData:{powDigest:o,targetZeros:r,startIndex:n*BigInt(u)}});i.push(s),s.on("message",(t=>_(this,void 0,void 0,(function*(){a=!0;for(let e=0;e<i.length;e++)yield i[e].terminate();e(BigInt(t))})))),s.on("error",(e=>{t(e)})),s.on("exit",(e=>{a||0===e||t(new Error(`Worker stopped with exit code ${e}`))}))}}))}))}};var b={},P=d&&d.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function a(e){try{s(o.next(e))}catch(e){i(e)}}function u(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,u)}s((o=o.apply(e,t||[])).next())}))},x=d&&d.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(b,"__esModule",{value:!0}),b.doPow=void 0;const D=l.default,j=x(s.default),B=c.default;function I(e,t,n){return P(this,void 0,void 0,(function*(){const o=yield D.promises.readFile(j.default.join(__dirname,"../wasm/build/release.wasm")),r=(yield WebAssembly.instantiate(o,function(){const e={abort:(e,t,n,o)=>{},trace:(e,t,...n)=>{},seed:Date.now};return{Math:Math,Date:Date,env:e}}())).instance.exports;for(let t=0;t<e.length;t++)r.setDigest(t,e[t]);const i=n&BigInt(4294967295),a=n>>BigInt(32)&BigInt(4294967295);r.powWorker(t,Number(i),Number(a));const u=r.getNonceLo(),s=r.getNonceHi();return BigInt(u)|BigInt(s)<<BigInt(32)}))}var k,M,O;b.doPow=I,B.workerData&&B.parentPort&&I(B.workerData.powDigest,B.workerData.targetZeros,B.workerData.startIndex).then((e=>{B.parentPort&&B.parentPort.postMessage(e.toString())})).catch((()=>{process.exit(1)})),k=p,M=d&&d.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),O=d&&d.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||M(t,e,n)},Object.defineProperty(k,"__esModule",{value:!0}),O(w,k),O(b,k);var W=f(p);module.exports=W;